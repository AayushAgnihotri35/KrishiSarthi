<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Linkage | KrishiSarthi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: #f5f5f5;
    }
    .navbar-nav {
      display: flex;
      justify-content: space-between;
      flex-wrap: nowrap;
      width: 100%;
      overflow-x: auto;
    }
    .navbar-nav .nav-item {
      flex: 1 1 auto;
      text-align: center;
      white-space: nowrap;
    }
    .market-img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 8px;
    }
    .card:hover {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      transform: scale(1.02);
      transition: all 0.3s ease;
    }
    
    /* Modal Styles */
    .modal-header {
      background: linear-gradient(135deg, #198754 0%, #20c997 100%);
      color: white;
    }
    
    .crop-specs {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .crop-specs h6 {
      color: #198754;
      margin-bottom: 10px;
    }
    
    .price-display {
      background: linear-gradient(135deg, #198754 0%, #20c997 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .price-display h3 {
      margin: 0;
      font-size: 32px;
    }
    
    .price-display p {
      margin: 5px 0 0 0;
      opacity: 0.9;
    }
    
    .benefit-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    
    .benefit-item i {
      color: #198754;
      font-size: 18px;
    }
    
    .form-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    #successMessage {
      display: none;
    }
    
    .success-animation {
      text-align: center;
      padding: 40px;
    }
    
    .success-animation i {
      font-size: 64px;
      color: #198754;
      animation: scaleIn 0.5s ease-out;
    }
    
    @keyframes scaleIn {
      0% {
        transform: scale(0);
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
      }
    }

    .msp-badge {
      background: #28a745;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="./assests/logo.jpg" alt="Logo" width="40" height="40" class="me-2">
        <strong>KrishiSarthi</strong>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="weather.html">Weather & Advisory</a></li>
          <li class="nav-item"><a class="nav-link" href="Equipment.html">Equipment</a></li>
          <li class="nav-item"><a class="nav-link" href="market.html">Market Linkage</a></li>
          <li class="nav-item"><a class="nav-link" href="marketplace.html">Market Place</a></li>
          <li class="nav-item"><a class="nav-link" href="insurance.html">Insurance</a></li>
          <li class="nav-item"><a class="nav-link" href="loan.html">Loan</a></li>
          <li class="nav-item"><a class="nav-link" href="subcidy.html">Subsidy</a></li>
          <li class="nav-item dropdown profile-dropdown ms-2">
            <a class="nav-link dropdown-toggle p-0" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <div class="profile-icon">
                <i class="fas fa-user"></i>
              </div>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
              <li>
                <a class="dropdown-item" href="profile.html">
                  <i class="fas fa-user-circle"></i> My Profile
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="orders.html">
                  <i class="fas fa-shopping-cart"></i> My Orders
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <a class="dropdown-item text-danger" href="#" id="logoutBtn">
                  <i class="fas fa-sign-out-alt"></i> Logout
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Market Linkage Section -->
  <div class="container py-5">
    <h2 class="text-center mb-4">Market Linkage</h2>
    <p class="text-center text-muted">Sell products directly, check MSPs and mandi rates based on real-time updates.</p>

    <!-- Market Cards -->
    <div class="row g-4" id="marketCards"></div>
  </div>

  <!-- Sell Crop Modal -->
  <div class="modal fade" id="sellModal" tabindex="-1" aria-labelledby="sellModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sellModalLabel">
            <i class="bi bi-cart-check me-2"></i>Sell Your Crop
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Form Content -->
          <div id="sellForm">
            <!-- Crop Details -->
            <div class="crop-specs">
              <h6><i class="bi bi-info-circle me-2"></i>Crop Details</h6>
              <div class="row">
                <div class="col-md-8">
                  <strong id="cropName">Crop Name</strong>
                  <div class="text-muted" id="cropCategory">Category: Grain</div>
                </div>
                <div class="col-md-4 text-end">
                  <span class="msp-badge" id="mspBadge">
                    <i class="bi bi-currency-rupee me-1"></i>MSP Available
                  </span>
                </div>
              </div>
            </div>

            <!-- Price Display -->
            <div class="price-display">
              <p class="mb-1">Current MSP (Minimum Support Price)</p>
              <h3 id="priceDisplay">₹2,150 / quintal</h3>
              <p class="small" id="priceNote">Prices updated as per government rates</p>
            </div>

            <!-- Benefits -->
            <div class="mb-4">
              <h6 class="mb-3"><i class="bi bi-star-fill text-warning me-2"></i>Why Sell Through Us?</h6>
              <div class="benefit-item">
                <i class="bi bi-check-circle-fill"></i>
                <span>Direct connection to verified buyers</span>
              </div>
              <div class="benefit-item">
                <i class="bi bi-check-circle-fill"></i>
                <span>Guaranteed MSP rates</span>
              </div>
              <div class="benefit-item">
                <i class="bi bi-check-circle-fill"></i>
                <span>Free quality testing</span>
              </div>
              <div class="benefit-item">
                <i class="bi bi-check-circle-fill"></i>
                <span>Quick payment within 48 hours</span>
              </div>
            </div>

            <!-- Seller Form -->
            <form id="sellerForm" class="form-section">
              <h6 class="mb-3"><i class="bi bi-person-fill me-2"></i>Seller Details</h6>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="sellerName" class="form-label">Full Name *</label>
                  <input type="text" class="form-control" id="sellerName" required>
                </div>
                <div class="col-md-6">
                  <label for="sellerPhone" class="form-label">Phone Number *</label>
                  <input type="tel" class="form-control" id="sellerPhone" pattern="[0-9]{10}" required>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="sellerEmail" class="form-label">Email Address</label>
                  <input type="email" class="form-control" id="sellerEmail">
                </div>
                <div class="col-md-6">
                  <label for="sellerLocation" class="form-label">Location *</label>
                  <input type="text" class="form-control" id="sellerLocation" placeholder="Village/City, District" required>
                </div>
              </div>

              <h6 class="mb-3 mt-4"><i class="bi bi-box-seam me-2"></i>Crop Information</h6>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="quantity" class="form-label">Quantity (in quintals) *</label>
                  <input type="number" class="form-control" id="quantity" min="1" placeholder="e.g., 50" required>
                </div>
                <div class="col-md-6">
                  <label for="quality" class="form-label">Quality Grade *</label>
                  <select class="form-select" id="quality" required>
                    <option value="">Select Quality</option>
                    <option value="premium">Premium (A Grade)</option>
                    <option value="standard">Standard (B Grade)</option>
                    <option value="fair">Fair (C Grade)</option>
                  </select>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="expectedPrice" class="form-label">Expected Price per Quintal *</label>
                  <input type="number" class="form-control" id="expectedPrice" placeholder="₹" required>
                </div>
                <div class="col-md-6">
                  <label for="harvestDate" class="form-label">Harvest Date</label>
                  <input type="date" class="form-control" id="harvestDate">
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Additional Services:</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="transportNeeded">
                  <label class="form-check-label" for="transportNeeded">
                    Need transportation assistance
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="storageNeeded">
                  <label class="form-check-label" for="storageNeeded">
                    Need temporary storage
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="qualityTest">
                  <label class="form-check-label" for="qualityTest">
                    Request quality testing before sale
                  </label>
                </div>
              </div>

              <div class="mb-3">
                <label for="additionalInfo" class="form-label">Additional Information</label>
                <textarea class="form-control" id="additionalInfo" rows="3" placeholder="Any specific buyer preferences, urgency, or other details..."></textarea>
              </div>

              <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle me-2"></i>
                <small>Our team will connect you with verified buyers within 24 hours. You'll receive multiple quotes to choose from.</small>
              </div>
            </form>
          </div>

          <!-- Success Message -->
          <div id="successMessage">
            <div class="success-animation">
              <i class="bi bi-check-circle-fill"></i>
              <h4 class="mt-3 text-success">Listing Submitted Successfully!</h4>
              <p class="text-muted">Your crop is now listed for sale. Buyers will contact you soon.</p>
              <div class="mt-4">
                <p class="mb-2"><strong>What happens next?</strong></p>
                <div class="benefit-item justify-content-center">
                  <i class="bi bi-search"></i>
                  <span>Buyers will review your listing</span>
                </div>
                <div class="benefit-item justify-content-center">
                  <i class="bi bi-telephone-fill"></i>
                  <span>Receive calls from interested buyers</span>
                </div>
                <div class="benefit-item justify-content-center">
                  <i class="bi bi-currency-rupee"></i>
                  <span>Compare offers and finalize deal</span>
                </div>
              </div>
              <div class="mt-4">
                <button class="btn btn-success me-2" onclick="location.href='orders.html'">
                  <i class="bi bi-list-check me-2"></i>View My Listings
                </button>
                <button class="btn btn-outline-success" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer" id="modalFooter">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="submitSell">
            <i class="bi bi-send me-2"></i>Submit Listing
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-success text-white text-center py-3 mt-5">
    <p class="mb-0">&copy; 2025 KrishiSarthi Platform. All rights reserved.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const marketData = [
      { name: 'Wheat', price: 2150, image: 'assests/wheat.jpg', category: 'Grain' },
      { name: 'Rice', price: 2060, image: 'assests/rice.jpg', category: 'Grain' },
      { name: 'Soybean', price: 4000, image: 'assests/soyabean.jpeg', category: 'Oilseed' },
      { name: 'Cotton', price: 6200, image: 'assests/cotton.jpg', category: 'Fiber' },
      { name: 'Maize', price: 1960, image: 'assests/maize.jpg', category: 'Grain' }
    ];

    let currentCropData = {};
    const cardContainer = document.getElementById('marketCards');

    // Create market cards
    marketData.forEach(crop => {
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4 mb-4';
      col.innerHTML = `
        <div class="card h-100">
          <img src="${crop.image}" alt="${crop.name}" class="market-img">
          <div class="card-body">
            <h5 class="card-title">${crop.name}</h5>
            <p class="card-text">MSP: ₹${crop.price} / quintal</p>
            <button class="btn btn-success w-100 sell-now-btn"
                    data-crop="${crop.name}"
                    data-price="${crop.price}"
                    data-category="${crop.category}">
              Sell Now
            </button>
          </div>
        </div>
      `;
      cardContainer.appendChild(col);
    });

    // Initialize sell buttons
    document.querySelectorAll('.sell-now-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        currentCropData = {
          name: this.getAttribute('data-crop'),
          price: this.getAttribute('data-price'),
          category: this.getAttribute('data-category')
        };
        openSellModal();
      });
    });

    function openSellModal() {
      // Reset modal
      document.getElementById('sellForm').style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('modalFooter').style.display = 'flex';
      document.getElementById('sellerForm').reset();
      
      // Set crop details
      document.getElementById('cropName').textContent = currentCropData.name;
      document.getElementById('cropCategory').textContent = `Category: ${currentCropData.category}`;
      document.getElementById('priceDisplay').textContent = `₹${currentCropData.price} / quintal`;
      document.getElementById('expectedPrice').value = currentCropData.price;

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('sellModal'));
      modal.show();
    }

    // Submit sell listing
    // Submit sell listing - WITH AUTHENTICATION
document.getElementById('submitSell').addEventListener('click', async function() {
  // ✅ CHECK IF USER IS LOGGED IN
  const token = localStorage.getItem('token');
  if (!token) {
    alert('Please login to create a crop listing');
    // Save form data for after login
    const formData = new FormData(document.getElementById('sellerForm'));
    localStorage.setItem('pendingCropListing', JSON.stringify(Object.fromEntries(formData)));
    window.location.href = 'Login.html';
    return;
  }

  const form = document.getElementById('sellerForm');
  
  if (form.checkValidity()) {
    const submitBtn = this;
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Submitting...';

    const sellingData = {
      crop: {
        name: currentCropData.name,
        category: currentCropData.category,
        msp: currentCropData.price
      },
      seller: {
        name: document.getElementById('sellerName').value,
        phone: document.getElementById('sellerPhone').value,
        email: document.getElementById('sellerEmail').value || null,
        location: document.getElementById('sellerLocation').value
      },
      cropDetails: {
        quantity: parseFloat(document.getElementById('quantity').value),
        quality: document.getElementById('quality').value,
        expectedPrice: parseFloat(document.getElementById('expectedPrice').value),
        harvestDate: document.getElementById('harvestDate').value || null
      },
      services: {
        transport: document.getElementById('transportNeeded').checked,
        storage: document.getElementById('storageNeeded').checked,
        qualityTest: document.getElementById('qualityTest').checked
      },
      additionalInfo: document.getElementById('additionalInfo').value || null
    };

    try {
      // ✅ SEND WITH AUTHENTICATION HEADERS
      const response = await fetch('https://krishisarthi-xar0.onrender.com/api/crop-listings', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`  // ✅ ADD AUTH TOKEN
        },
        body: JSON.stringify(sellingData)
      });

      // ✅ CHECK FOR AUTH ERRORS
      if (response.status === 401) {
        alert('Session expired. Please login again');
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        localStorage.removeItem('fullname');
        window.location.href = 'Login.html';
        return;
      }

      if (!response.ok) {
        throw new Error('Failed to submit listing');
      }

      const result = await response.json();
      console.log('Crop listing saved successfully:', result);

      // Show success message
      document.getElementById('sellForm').style.display = 'none';
      document.getElementById('successMessage').style.display = 'block';
      document.getElementById('modalFooter').style.display = 'none';

    } catch (error) {
      console.error('Error submitting listing:', error);
      alert('Failed to submit listing. Please try again or contact support.');
      
      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  } else {
    form.reportValidity();
  }
});

// ✅ ADD THIS NEW CODE AT THE END

// Optional: Show user info in navbar if logged in
document.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('token');
  const username = localStorage.getItem('username');
  
  if (token && username) {
    // Update navbar to show logged in state
    const profileDropdown = document.querySelector('.profile-dropdown');
    if (profileDropdown) {
      profileDropdown.style.display = 'block';
    }
  }
});

// Handle logout
document.getElementById('logoutBtn').addEventListener('click', (e) => {
  e.preventDefault();
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('token');
    localStorage.removeItem('username');
    localStorage.removeItem('fullname');
    window.location.href = 'Login.html';
  }
});
  </script>
</body>
</html>